<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Personal Billing System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--p:#2563eb; --a:#10b981; --bg:#f3f4f6; --card:#fff; --txt:#111827; --sub:#6b7280;}
*{box-sizing:border-box; font-family:system-ui, sans-serif; margin:0; padding:0;}
body{background:var(--bg); color:var(--txt);}
header{display:flex; align-items:center; gap:1rem; padding:1rem; background:var(--card); box-shadow:0 1px 3px rgba(0,0,0,.1);}
header img{max-height:48px;}
nav{display:flex; gap:.5rem;}
nav button{padding:.5rem 1rem; border:none; background:transparent; color:var(--p); cursor:pointer; font-weight:600; border-radius:.375rem;}
nav button.active{background:var(--p); color:#fff;}
.tab{display:none; padding:1rem; max-width:900px; margin:auto;}
.tab.active{display:block;}
.card{background:var(--card); padding:1rem; border-radius:.5rem; box-shadow:0 1px 3px rgba(0,0,0,.05); margin-bottom:1rem}
.row{display:flex; gap:1rem; flex-wrap:wrap}
.col{flex:1 1 220px; display:flex; flex-direction:column; gap:.5rem}
label{font-size:.875rem; color:var(--sub)}
input,textarea,select{width:100%; padding:.5rem; border:1px solid #d1d5db; border-radius:.375rem}
button{padding:.5rem 1rem; border:none; border-radius:.375rem; background:var(--p); color:#fff; cursor:pointer}
button.small{padding:.25rem .5rem; font-size:.875rem}
table{width:100%; border-collapse:collapse; font-size:.875rem}
th,td{padding:.5rem; text-align:left; border-bottom:1px solid #e5e7eb}
tbody tr:hover{background:#f9fafb}
.toast{position:fixed; bottom:1rem; right:1rem; background:#111827; color:#fff; padding:.75rem 1rem; border-radius:.375rem; opacity:0; transition:.3s}
.toast.show{opacity:1}
#printArea{display:none}
@media print{
  body *{visibility:hidden}
  #printArea, #printArea *{visibility:visible}
  #printArea{position:fixed; inset:0; background:#fff;padding:10mm;width:210mm;min-height:277mm;margin:0 auto;box-shadow:none}
}
</style>
</head>
<body>
<header>
  <img id="logoPrev" src="" alt="" style="display:none; max-height:48px">
  <div>
    <h1 id="bizTitle">My Business</h1>
    <small id="bizContact"></small>
  </div>
</header>
<nav>
  <button class="tabBtn active" data-tab="settings">Settings</button>
  <button class="tabBtn" data-tab="products">Products</button>
  <button class="tabBtn" data-tab="invoice">New Invoice</button>
  <button class="tabBtn" data-tab="browse">Browse</button>
</nav>

<!-- SETTINGS -->
<div id="settings" class="tab active">
  <div class="card">
    <h2>Business Settings</h2>
    <div class="row">
      <div class="col"><label>Name</label><input id="bName"></div>
      <div class="col"><label>Address</label><textarea id="bAddr"></textarea></div>
      <div class="col"><label>Phone</label><input id="bPhone"></div>
      <div class="col"><label>Email</label><input id="bEmail"></div>
      <div class="col"><label>CR No</label><input id="bCR"></div>
      <div class="col"><label>VAT No</label><input id="bVAT"></div>
      <div class="col"><label>Logo</label><input type="file" id="bLogo" accept="image/*"></div>
    </div>
    <button onclick="saveBiz()">Save</button>
  </div>
</div>

<!-- PRODUCTS -->
<div id="products" class="tab">
  <div class="card row" style="align-items:center">
    <input type="file" id="prodCsv" accept=".csv" class="no-print">
    <button onclick="loadProds()">Load products.csv</button>
    <button onclick="saveProds()">Save products.csv</button>
    <input placeholder="Search…" oninput="filterProd(this.value)" style="margin-left:auto; max-width:200px" class="no-print">
  </div>
  <div class="card">
    <table id="prodTbl"><thead><tr><th>Code</th><th>Description</th><th>Price</th><th>Tax %</th><th class="no-print"></th></tr></thead><tbody></tbody></table>
    <div class="row no-print" style="margin-top:.5rem">
      <input placeholder="Code" id="pCode">
      <input placeholder="Description" id="pDesc">
      <input placeholder="Price" id="pPrice" type="number" step="0.01">
      <input placeholder="Tax %" id="pTax" type="number" step="0.01">
      <button onclick="addProd()">Add</button>
    </div>
  </div>
</div>

<!-- NEW INVOICE -->
<div id="invoice" class="tab">
  <div class="card">
    <div class="row">
      <div class="col"><label>Invoice #</label><input id="iNum" readonly></div>
      <div class="col"><label>Date</label><input id="iDate" type="date"></div>
    </div>
  </div>
  <div class="card">
    <h3>Customer</h3>
    <div class="row">
      <div class="col"><label>Name</label><input id="cName"></div>
      <div class="col"><label>Phone</label><input id="cPhone"></div>
      <div class="col"><label>Email</label><input id="cEmail"></div>
      <div class="col"><label>Address</label><textarea id="cAddr"></textarea></div>
    </div>
  </div>
  <div class="card">
    <h3>Items</h3>
    <table id="itemTbl"><thead><tr><th>Description</th><th>Qty</th><th>Price</th><th>Disc %</th><th>Total</th><th class="no-print"></th></tr></thead><tbody></tbody></table>
    <div class="row no-print" style="margin-top:.5rem">
      <input placeholder="Type to search…" id="itSearch" style="flex:2" oninput="suggestItem(this.value)">
      <input placeholder="Qty" id="itQty" type="number" value="1" min="1">
      <input placeholder="Disc %" id="itDisc" type="number" value="0" min="0" max="100" step="0.01">
      <button onclick="addItem()">Add</button>
    </div>
    <div id="suggest" style="border:1px solid #d1d5db; max-height:150px; overflow:auto; background:#fff; display:none"></div>
  </div>
  <div class="card row" style="justify-content:flex-end">
    <div>
      <div>Subtotal: <b id="st">0.00</b></div>
      <div>Tax: <b id="tx">0.00</b></div>
      <div>Total: <b id="gt">0.00</b></div>
    </div>
  </div>
  <div class="card no-print">
    <label><input type="checkbox" id="paid"> Mark Paid</label>
    <button onclick="saveInv()">Save Invoice</button>
    <button onclick="printInv()">Print</button>
  </div>
</div>

<!-- BROWSE -->
<div id="browse" class="tab">
  <div class="card row" style="align-items:center">
    <input placeholder="Search…" oninput="filterInv(this.value)" style="max-width:250px" class="no-print">
  </div>
  <div class="card">
    <table id="invTbl"><thead><tr><th>Invoice</th><th>Date</th><th>Customer</th><th>Total</th><th>Paid</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<!-- PRINT AREA -->
<div id="printArea"></div>
<div id="toast" class="toast"></div>

<script>
/* ---------- base64 logo ---------- */
let logoB64='';
/* ---------- csv ---------- */
const enc=v=>typeof v==='string'&&v.match(/[,"]/)?'"'+v.replace(/"/g,'""')+'"':v;
const parse=txt=>txt.trim().split(/\r?\n/).map(l=>{
  const r=[], cur=['']; let q=0;
  for(let i=0;i<l.length;i++){
    const c=l[i], n=l[i+1]||'';
    if(c==='"'){if(n==='"'){cur[cur.length-1]+='"'; i++;} else q=!q;}
    else if(c===','&&!q){cur.push('');}
    else cur[cur.length-1]+=c;
  }
  return cur;
});
let products=[], invoices=[];
/* ---------- helpers ---------- */
const $=q=>document.querySelector(q);
const toast=(m,t=2500)=>{const x=$('#toast'); x.textContent=m; x.classList.add('show'); setTimeout(()=>x.classList.remove('show'),t);}
const dl=(fn,csv)=>{const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download=fn; a.click();}
/* ---------- settings ---------- */
function loadBiz(){
  const b=JSON.parse(localStorage.getItem('biz')||'{}');
  $('#bizTitle').textContent=b.name||'My Business';
  $('#bName').value=b.name||''; $('#bAddr').value=b.address||''; $('#bPhone').value=b.phone||''; $('#bEmail').value=b.email||''; $('#bCR').value=b.cr||''; $('#bVAT').value=b.vat||'';
  logoB64=b.logo||''; if(logoB64){$('#logoPrev').src=logoB64; $('#logoPrev').style.display='block';}
}
function saveBiz(){
  const b={name:$('#bName').value.trim()||'My Business',address:$('#bAddr').value.trim(),phone:$('#bPhone').value.trim(),email:$('#bEmail').value.trim(),cr:$('#bCR').value.trim(),vat:$('#bVAT').value.trim(),logo:logoB64};
  localStorage.setItem('biz',JSON.stringify(b));
  loadBiz(); toast('Saved');
}
$('#bLogo').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{logoB64=ev.target.result; localStorage.setItem('logoFileName',f.name);};
  r.readAsDataURL(f);
});
/* ---------- products ---------- */
function loadProds(){
  const f=$('#prodCsv').files[0]; if(!f){toast('Choose products.csv'); return;}
  const r=new FileReader();
  r.onload=e=>{products=parse(e.target.result).slice(1).filter(r=>r.length>=4); renderProds(); toast('Products loaded');};
  r.readAsText(f);
}
function saveProds(){
  if(!products.length){toast('No products'); return;}
  const csv='ProductCode,Description,UnitPrice,TaxPercent\n'+products.map(p=>p.map(enc).join(',')).join('\n');
  dl('products.csv',csv);
}
function renderProds(arr=products){
  const t=$('#prodTbl tbody'); t.innerHTML='';
  arr.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p[0]}</td><td>${p[1]}</td><td>${p[2]}</td><td>${p[3]}</td><td class="no-print"><button class="small" onclick="delProd(${i})">Del</button></td>`;
    t.appendChild(tr);
  });
}
function addProd(){
  const c=$('#pCode').value.trim(), d=$('#pDesc').value.trim(), p=parseFloat($('#pPrice').value), t=parseFloat($('#pTax').value)||0;
  if(!c||!d||isNaN(p)){toast('Check fields'); return;}
  products.push([c,d,p,t]); renderProds(); saveProds();
  $('#pCode').value=$('#pDesc').value=$('#pPrice').value=$('#pTax').value='';
}
function delProd(i){products.splice(i,1); renderProds(); saveProds();}
function filterProd(v){
  const f=products.filter(p=>p[1].toLowerCase().includes(v.toLowerCase())||p[0].toLowerCase().includes(v.toLowerCase()));
  renderProds(f);
}
/* ---------- invoice ---------- */
let items=[], invNo=1;
function resetInv(){
  invNo=invoices.length?Math.max(...invoices.map(r=>+r[0]))+1:1;
  $('#iNum').value=String(invNo).padStart(4,'0');
  $('#iDate').value=new Date().toISOString().slice(0,10);
  $('#cName').value=$('#cPhone').value=$('#cEmail').value=$('#cAddr').value='';
  items=[]; renderItems(); calcTotals();
}
function renderItems(){
  const t=$('#itemTbl tbody'); t.innerHTML='';
  items.forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.desc}</td><td>${it.qty}</td><td>${it.price.toFixed(2)}</td><td>${it.disc}</td><td>${it.total.toFixed(2)}</td><td class="no-print"><button class="small" onclick="delItem(${i})">Del</button></td>`;
    t.appendChild(tr);
  });
}
function calcTotals(){
  let sub=0, tax=0;
  items.forEach(it=>{
    const amt=it.qty*it.price*(1-it.disc/100);
    sub+=amt; tax+=amt*(it.tax/100);
  });
  $('#st').textContent=sub.toFixed(2); $('#tx').textContent=tax.toFixed(2); $('#gt').textContent=(sub+tax).toFixed(2);
}
function suggestItem(v){
  const d=$('#suggest'); if(!v){d.style.display='none'; return;}
  const f=products.filter(p=>p[1].toLowerCase().includes(v.toLowerCase()));
  d.innerHTML=''; f.forEach(p=>{
    const o=document.createElement('div'); o.textContent=p[1]; o.style.padding='.5rem'; o.style.cursor='pointer';
    o.onclick=()=>{$('#itSearch').value=p[1]; d.style.display='none';};
    d.appendChild(o);
  });
  d.style.display=f.length?'block':'none';
}
function addItem(){
  const desc=$('#itSearch').value.trim(); const p=products.find(pr=>pr[1]===desc);
  if(!p){toast('Pick product'); return;}
  const qty=parseInt($('#itQty').value)||1, disc=parseFloat($('#itDisc').value)||0;
  const price=parseFloat(p[2]), tax=parseFloat(p[3]);
  const total=qty*price*(1-disc/100);
  items.push({desc,qty,price,disc,tax,total}); renderItems(); calcTotals();
  $('#itSearch').value=''; $('#itQty').value='1'; $('#itDisc').value='0'; $('#suggest').style.display='none';
}
function delItem(i){items.splice(i,1); renderItems(); calcTotals();}
function saveInv(){
  if(!items.length){toast('Add items'); return;}
  const biz=JSON.parse(localStorage.getItem('biz')||'{}');
  const [id,dt]=[$('#iNum').value,$('#iDate').value];
  const [cn,cp,ce,ca]=[$('#cName').value.trim(),$('#cPhone').value.trim(),$('#cEmail').value.trim(),$('#cAddr').value.trim()];
  if(!cn){toast('Customer name required'); return;}
  const its=JSON.stringify(items);
  const [sub,tax,gt]=[parseFloat($('#st').textContent),parseFloat($('#tx').textContent),parseFloat($('#gt').textContent)];
  const paid=$('#paid').checked?'Yes':'No';
  invoices.push([id,dt,cn,cp,ce,ca,biz.name||'',biz.address||'',biz.phone||'',biz.email||'',biz.cr||'',biz.vat||'',localStorage.getItem('logoFileName')||'',its,sub,tax,gt,paid]);
  saveInvCSV(); resetInv(); toast('Invoice saved');
}
function saveInvCSV(){
  const csv='InvoiceID,Date,CustomerName,CustomerPhone,CustomerEmail,CustomerAddress,BusinessName,BusinessAddress,BusinessPhone,BusinessEmail,CRNo,VATNo,LogoFileName,ItemsJSON,SubTotal,TaxTotal,GrandTotal,PaidStatus\n'+invoices.map(r=>r.map(enc).join(',')).join('\n');
  dl('invoices.csv',csv);
}
function printInv(){
  const biz=JSON.parse(localStorage.getItem('biz')||'{}');
  const [id,dt]=[$('#iNum').value,$('#iDate').value];
  const [cn,cp,ce,ca]=[$('#cName').value.trim(),$('#cPhone').value.trim(),$('#cEmail').value.trim(),$('#cAddr').value.trim()];
  const [sub,tax,gt]=[$('#st').textContent,$('#tx').textContent,$('#gt').textContent];
  const paid=$('#paid').checked;

  // ---- build printable HTML ----
  let h=`
  <style>
    @page{size:A4; margin:10mm}
    html,body{margin:0;padding:0;background:#fff;font-family:Arial,Helvetica,sans-serif;font-size:11pt;color:#000}
    .inv{position:relative;width:190mm;min-height:277mm;margin:0 auto;display:flex;flex-direction:column}
    .inv *{box-sizing:border-box}
    .hdr{display:flex;align-items:center;gap:3rem;margin-bottom:2rem}
    .hdr img{max-height:60px}
    .hdr h2{margin:0;font-size:20pt;font-weight:700}
    .hdr small{display:block;font-size:10pt;margin-top:4px;color:#555}
    .mid{display:flex;justify-content:space-between;margin-bottom:1.5rem}
    .mid div h3{margin:0 0 4px;font-size:14pt}
    .mid div p{margin:2px 0;font-size:10pt}
    table{width:100%;border-collapse:collapse;margin-bottom:1rem;font-size:10pt}
    th,td{padding:6px 8px;border:1px solid #ccc}
    th{background:#f5f5f5;font-weight:700}
    .tot{text-align:right;margin-top:1rem;font-size:11pt}
    .tot b{font-size:13pt}
    .paid{font-size:14pt;font-weight:700;color:#10b981;margin-top:1rem}
    .water{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-30deg);opacity:.08;z-index:0;pointer-events:none}
    .water img{max-width:300px}
  </style>
  <div class="inv">
    ${logoB64?`<div class="water"><img src="${logoB64}"></div>`:''}
    <div class="hdr">
      ${logoB64?`<img src="${logoB64}">`:''}
      <div>
        <h2>${biz.name||'My Business'}</h2>
        <small>${biz.address||''} • ${biz.phone||''} • ${biz.email||''} • CR: ${biz.cr||''} • VAT: ${biz.vat||''}</small>
      </div>
    </div>

    <div class="mid">
      <div>
        <h3>Invoice #${id}</h3>
        <p>Date: ${dt}</p>
      </div>
      <div>
        <h3>Bill To</h3>
        <p>${cn}</p>
        <p>${ca}</p>
        <p>${cp} • ${ce}</p>
      </div>
    </div>

    <table>
      <thead><tr><th style="width:50%">Description</th><th>Qty</th><th>Unit Price</th><th>Disc %</th><th>Total</th></tr></thead>
      <tbody>`;
  items.forEach(it=>{
    h+=`<tr><td>${it.desc}</td><td>${it.qty}</td><td>${it.price.toFixed(2)}</td><td>${it.disc}</td><td>${it.total.toFixed(2)}</td></tr>`;
  });
  h+=`</tbody></table>

    <div class="tot">
      <div>Subtotal: <b>${sub}</b></div>
      <div>Tax: <b>${tax}</b></div>
      <div>Grand Total: <b>${gt}</b></div>
      ${paid?'<div class="paid">PAID</div>':''}
    </div>
  </div>`;

  $('#printArea').innerHTML=h;
  window.print();
}
function filterInv(v){
  const rows=Array.from($('#invTbl tbody').rows);
  rows.forEach(r=>r.style.display=r.textContent.toLowerCase().includes(v.toLowerCase())?'':'none');
}
function loadBrowse(){
  const t=$('#invTbl tbody'); t.innerHTML='';
  invoices.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><a href="#" onclick="viewOld('${r[0]}'); return false">${r[0]}</a></td><td>${r[1]}</td><td>${r[2]}</td><td>${parseFloat(r[16]).toFixed(2)}</td><td>${r[17]}</td>`;
    t.appendChild(tr);
  });
}
function viewOld(id){
  const r=invoices.find(rr=>rr[0]===id); if(!r){toast('Not found'); return;}
  const [iid,dt,cn,cp,ce,ca,bn,ba,bp,be,bcr,bvat,fn,its,sub,tax,gt,paid]=r;
  const itsOb=JSON.parse(its);
  let h=`
  <style>
    @page{size:A4;margin:10mm}
    body{margin:0;background:#fff;font-family:Arial,Helvetica,sans-serif;font-size:11pt}
    .inv{width:190mm;min-height:277mm;margin:0 auto}
    .hdr{display:flex;align-items:center;gap:3rem;margin-bottom:2rem}
    .hdr img{max-height:60px}
    .hdr h2{margin:0;font-size:20pt}
    .hdr small{display:block;font-size:10pt;margin-top:4px;color:#555}
    .mid{display:flex;justify-content:space-between;margin-bottom:1.5rem}
    .mid h3{margin:0 0 4px;font-size:14pt}
    .mid p{margin:2px 0;font-size:10pt}
    table{width:100%;border-collapse:collapse;font-size:10pt}
    th,td{padding:6px 8px;border:1px solid #ccc}
    th{background:#f5f5f5}
    .tot{text-align:right;margin-top:1rem}
    .tot b{font-size:13pt}
    .paid{font-size:14pt;font-weight:700;color:#10b981;margin-top:1rem}
    .water{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-30deg);opacity:.08;pointer-events:none}
    .water img{max-width:300px}
  </style>
  <div class="inv">
    ${logoB64?`<div class="water"><img src="${logoB64}"></div>`:''}
    <div class="hdr">
      ${logoB64?`<img src="${logoB64}">`:''}
      <div>
        <h2>${bn}</h2>
        <small>${ba} • ${bp} • ${be} • CR: ${bcr} • VAT: ${bvat}</small>
      </div>
    </div>
    <div class="mid">
      <div><h3>Invoice #${iid}</h3><p>Date: ${dt}</p></div>
      <div><h3>Bill To</h3><p>${cn}</p><p>${ca}</p><p>${cp} • ${ce}</p></div>
    </div>
    <table><thead><tr><th style="width:50%">Description</th><th>Qty</th><th>Unit</th><th>Disc %</th><th>Total</th></tr></thead><tbody>`;
  itsOb.forEach(it=>h+=`<tr><td>${it.desc}</td><td>${it.qty}</td><td>${it.price.toFixed(2)}</td><td>${it.disc}</td><td>${it.total.toFixed(2)}</td></tr>`);
  h+=`</tbody></table>
    <div class="tot">
      <div>Subtotal: <b>${parseFloat(sub).toFixed(2)}</b></div>
      <div>Tax: <b>${parseFloat(tax).toFixed(2)}</b></div>
      <div>Grand Total: <b>${parseFloat(gt).toFixed(2)}</b></div>
      ${paid==='Yes'?'<div class="paid">PAID</div>':''}
    </div>
  </div>`;
  $('#printArea').innerHTML=h;
  window.print();
}
/* ---------- nav ---------- */
document.querySelectorAll('.tabBtn').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tabBtn').forEach(t=>t.classList.remove('active'));
    $(`#${b.dataset.tab}`).classList.add('active'); b.classList.add('active');
    if(b.dataset.tab==='invoice') resetInv();
    if(b.dataset.tab==='browse') loadBrowse();
  };
});
/* ---------- init ---------- */
loadBiz(); resetInv();
</script>
</body>
</html>
